---

# ==============================
# Disable QXL (Linux only)
# ==============================

- name: disable qxl
  hosts:
    - routers
    - server
  gather_facts: yes
  become: yes
  tasks:
    - include_role:
        name: disable-qxl
      when: ansible_os_family == 'Debian'


# ==============================
# Linux Server Setup
# ==============================

- name: set up server
  hosts: server
  become: yes
  roles:
    - role: server
      telnet_port: "{{ telnet_port }}"
      flag: "{{ alice_flag }}"
      flag_2: "{{ root_flag }}"


# ==============================
# Windows Client Configuration
# (No external collections required)
# ==============================

- name: set up windows client
  hosts: windows-host
  gather_facts: yes
  tasks:

    - name: Create local Windows user
      win_user:
        name: user
        password: Password123
        state: present
        groups:
          - Users

    - name: Enable Remote Desktop in registry
      win_shell: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
        -Name "fDenyTSConnections" -Value 0

    - name: Enable RDP firewall rule
      win_shell: |
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Add user to Remote Desktop Users group
      win_shell: |
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "user"


# ==============================
# Command Logging (Linux Server)
# ==============================

- name: set up command logging
  hosts: server
  become: yes
  roles:
    - role: sandbox-logging
      slf_destination_port: '{% if hostvars["man"] is defined -%} 514 {%- else -%} 515 {%- endif %}'

...
